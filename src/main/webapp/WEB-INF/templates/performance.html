<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head"/>

<body>
<div class="container-fluid">
    <div class="panel panel-default">
        <div class="panel-heading">
            <table border="0" width="100%">
                <tr>
                    <td width="10%">
                        <img src="../static/images/JBS_Transparent.png" th:src="@{'/images/JBS_Transparent.png'}" class="img-thumbnail" width="100" height="200"/>
                    </td>
                    <td align="center"><h3 class="panel-title"><b>Add Performance Management</b></h3></td>
                    <td width="20%">
                        <form class="form-inline" style="margin-top: 1px">
                            <div class="form-group">
                                <label>Search:</label>
                                <input type="text" class="form-control" style="width: 50%"/>
                                <span class="form-control glyphicon glyphicon-search input-sm borderless"/>
                            </div>
                        </form>
                    </td>
                </tr>
            </table>
        </div>
        <form action="#" th:action="${performanceDto.isUpdate()} ?
                @{'/employee/' + ${employee.id} + '/performance/update/' + ${performanceDto.id}} + '?' + ${_csrf.parameterName} + '=' + ${_csrf.token} :
                @{'/employee/' + ${employee.id} + '/performance/create'} + '?' + ${_csrf.parameterName} + '=' + ${_csrf.token} " th:object="${performanceDto}"
              method="post" enctype="multipart/form-data">

            <input id="removedAttachmentsId" th:type="hidden" th:field="*{removedAttachments}"/>
            <input th:type="hidden" th:field="*{id}"/>

            <div class="panel-body body-background">
                <div class="row">
                    <div class="col-md-12">
                        <div th:if="${#fields.hasErrors('*')}" class="alert alert-danger">
                            <p>Please correct values in error below: </p>
                            <ul>
                                <li th:each="err : ${#fields.errors('*')}" th:text="${err}" />
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="col-md-2">
                            <b>Name</b>
                        </div>
                        <div class="col-md-4">
                            <label class="normal" th:text="${employee.fullName}"/>
                        </div>
                        <div class="col-md-2">
                            <b>Employee ID</b>
                        </div>
                        <div class="col-md-4">
                            <label class="normal" th:text="${employee.employeeNumber}"/>
                        </div>
                        <div class="col-md-2">
                            <b>Department</b>
                        </div>
                        <div class="col-md-4">
                            <label class="normal" th:text="${employee.department.name}"/>
                        </div>
                        <div class="col-md-2">
                            <b>Position</b>
                        </div>
                        <div class="col-md-4">
                            <label class="normal" th:text="${employee.position.name}"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="well"
                             style="font-size:14px;background-color: #c3dbef !important; border-color: #2aabd2; color: white">
                            <div class="row text-center">
                                <label style="color: black"><u>Quick Links</u></label>
                            </div>
                            <div class="row text-left">
                                <div class="col-md-6">
                                    <label style="color: black">&bull;</label> <a href="#" style="color: black">Add Leave</a>
                                </div>
                                <div class="col-md-6">
                                    <label style="color: black">&bull;</label> <a href="#" style="color: black">Event Report</a>
                                </div>
                            </div>
                            <div class="row text-left">
                                <div class="col-md-6">
                                    <label style="color: black">&bull;</label> <a href="#" th:href="@{/event}" style="color: black">Add Event</a>
                                </div>
                                <div class="col-md-6">
                                    <label style="color: black">&bull;</label> <a href="#" style="color: black">PM Report</a>
                                </div>
                            </div>
                            <div class="row text-left">
                                <div class="col-md-6">
                                    <label style="color: black">&bull;</label> <a href="#" th:href="@{/performance}" style="color: black">Add PM</a>
                                </div>
                                <div class="col-md-6">
                                    <label style="color: black">&bull;</label> <a href="#" style="color: black">Employee Central</a>
                                </div>
                            </div>
                            <div class="row text-left">
                                &nbsp;
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: 20px">
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('parentCategoryId')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background" style="padding-left: 0px">Category :</label>
                            <select id="parentCategoryId" class="form-control" th:field="*{parentCategoryId}">
                                <option value="">-- Please Select --</option>
                                <option th:each="category : ${listCategory}" th:value="${category.id}" th:text="${category.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('categoryId')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background">Sub Category :</label>
                            <select id="categoryId" class="form-control" th:field="*{categoryId}">
                                <option value="">-- Please Select --</option>
                                <option th:each="category : ${listSubCategory}" th:value="${category.id}" th:text="${category.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('actionId')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background">Action :</label>
                            <select id="actionId" class="form-control" th:field="*{actionId}">
                                <option value="">-- Please Select --</option>
                                <option th:each="action : ${listAction}" th:value="${action.id}" th:text="${action.name}"></option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: 20px">
                    <div class="col-md-3">
                        <div class="input-group">
                            <label class="input-group-addon borderless no-background" style="padding-left: 0px">Template :</label>
                            <select id="letterTemplateId" class="form-control" th:field="*{letterTemplateId}">
                                <option value="">-- Please Select --</option>
                                <option th:each="template : ${listLetterTemplate}" th:value="${template.id}" th:text="${template.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group" style="width: 100%" th:class="${#fields.hasErrors('startDate')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background ">Start Date :</label>
                            <div class='input-group date' id='datetimepicker1'>
                                <input type='text' class="form-control" th:field="*{startDate}"/>
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group" style="width: 100%" th:class="${#fields.hasErrors('endDate')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background ">End Date :</label>
                            <div class='input-group date' id='datetimepicker2'>
                                <input type='text' class="form-control" th:field="*{endDate}"/>
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group" style="width: 100%" th:class="${#fields.hasErrors('startTime')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background ">Time :</label>
                            <div class='input-group date' id='datetimepicker3'>
                                <input type='text' class="form-control" th:field="*{startTime}"/>
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: 20px">
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('issuedBy')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background " style="padding-left: 0px">Issued By :</label>
                            <input type="text" class="form-control" th:field="*{issuedBy}"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('place')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background ">Place :</label>
                            <input type="text" class="form-control" th:field="*{place}"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('attendee')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background ">Attendees :</label>
                            <input type="text" class="form-control" th:field="*{attendee}"/>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: 20px">
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('supportResponse')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background " style="padding-left: 0px">Support Response :</label>
                            <input type="text" class="form-control" th:field="*{supportResponse}"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group" th:class="${#fields.hasErrors('supportPerson')} ? 'input-group has-error' : 'input-group'">
                            <label class="input-group-addon borderless no-background ">Support Person :</label>
                            <input type="text" class="form-control" th:field="*{supportPerson}"/>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <label class="input-group-addon borderless no-background">Interpreter :</label>
                            <select class="form-control" th:field="*{interpreter}">
                                <option value="1">Yes</option>
                                <option value="0">No</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-8">
                        <div class="form-group" th:class="${#fields.hasErrors('comment')} ? 'form-group has-error' : 'form-group'">
                            <label class="normal">Comments :</label>
                            <textarea class="form-control" rows="6" th:field="*{comment}"></textarea>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="row">
                            <div class="col-md-12">&nbsp;</div>
                        </div>
                        <div class="row" style="margin-bottom: 10px">
                            <div class="col-md-12">
                                <div class="checkbox">
                                    <input type="checkbox" value=""/><label>Supervisor Report</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <a href="#" th:onclick="'javascript:generateTemplate()'">
                                    <button type="button" class="btn btn-info">Generate Letter</button>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="input-group">
                            <label class="input-group-addon borderless no-background" style="padding-left: 0px">Attachment :</label>
                            <label class="input-group-btn">
                                <span class="btn btn-primary">
                                    Browse&hellip; <input type="file" style="display: none;" multiple="true" th:field="*{files}"/>
                                </span>
                            </label>
                            <input type="text" class="form-control" readonly="true"/>
                        </div>
                    </div>
                </div>
                <div th:id="'attachment'+${attachment.id}" class="row" th:each="attachment : ${performanceDto.getAttachments()}">
                    <div class="col-md-4">
                        <div class="input-group" style="margin-top: 15px" >
                            <a class="input-group-addon borderless no-background" href="#" th:href="@{/performance/download_attachment/} + ${attachment.id}" th:target="_blank" th:text="${attachment.documentName}"></a>
                            <button type="button" class="btn btn-info btn-sm" style="width: 35px;" th:onclick="'javascript:removeAttachment(' + ${attachment.id} +  ',attachment'+${attachment.id} + ')'">
                                <span class="glyphicon glyphicon-remove"></span>
                            </button>
                        </div>

                    </div>
                </div>

                <div class="row" style="margin-top: 20px">
                    <div class="col-md-4">
                        <div class="well" style="background-color: #dca7a7 !important; border-color: #c9302c; color: white">
                            <div class="row text-center">
                                <label> UA(4) | AB(3) | PC(3) | PCN(2) </label>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2  col-md-offset-4">
                        <button type="submit" class="btn btn-info" th:if="${!performanceDto.isAuditVersion()}">Save</button>
                    </div>
                    <div class="col-md-2">
                        <a href="#" th:href="@{/}">
                            <button type="button" class="btn btn-info">Close</button>
                        </a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <label>
                            <a href="#"><u>&lt;PM History&gt;</u></a>
                        </label>
                    </div>
                </div>
                <div class="row" style="margin-bottom: 10px">
                    <div class="col-md-3">
                        <div class="input-group">
                            <label class="input-group-addon borderless no-background" style="padding-left: 0px">Action :</label>
                            <select id="historyActionId" class="form-control">
                                <option value="">-- Please Select --</option>
                                <option th:each="action : ${listActionBasedHistory}" th:value="${action.id}" th:text="${action.name}"></option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <label class="input-group-addon borderless no-background">Start :</label>
                            <div class='input-group date'>
                                <input id='historyStartDatePicker' type='text' class="form-control"/>
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <label class="input-group-addon borderless no-background">End :</label>
                            <div class='input-group date'>
                                <input id='historyEndDatePicker' type='text' class="form-control"/>
                                <span class="input-group-addon">
                                    <span class="glyphicon glyphicon-calendar"></span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select id="historyMonthId" class="form-control">
                            <option value="">Months</option>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="9">9 Months</option>
                            <option value="12">12 Months</option>
                            <option value="18">18 Months</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table id="historyTable" class="table table-bordered table-condensed table-hover">
                                <thead>
                                    <tr class="success">
                                        <td class="text-center">PM ID</td>
                                        <td class="text-center">Action</td>
                                        <td class="text-center">Start Date</td>
                                        <td class="text-center">Time</td>
                                        <td class="text-center">End Date</td>
                                        <td class="text-center">Last Modified Date</td>
                                        <td class="text-center">Last Modified By</td>
                                    </tr>
                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div th:class="${performanceDto.isUpdate()} ? 'row' : 'hide'">
                    <div class="col-md-12">
                        <label>
                            <a href="#"><u>&lt;Audit&gt;</u></a>
                        </label>
                    </div>
                </div>
                <div th:class="${performanceDto.isUpdate()} ? 'row' : 'hide'">
                    <div class="col-md-12">
                        <div class="table-responsive">
                            <table class="table table-bordered table-condensed table-hover">
                                <thead>
                                    <tr class="success">
                                        <td class="text-center">#</td>
                                        <td class="text-center">PM ID</td>
                                        <td class="text-center">Action</td>
                                        <td class="text-center">Start Date</td>
                                        <td class="text-center">Time</td>
                                        <td class="text-center">End Date</td>
                                        <td class="text-center">Last Modified Date</td>
                                        <td class="text-center">Last Modified By</td>
                                    </tr>
                                </thead>
                                <tbody>
                                <tr th:each="revision,iterationStatus  : ${performanceRevisions}" class="info">
                                    <td th:text="${iterationStatus.count}"></td>
                                    <td><a th:href="@{/} + 'performance/'+ ${revision.id} +'/revision/' + ${revision.revisionNumber}" th:text="${revision.id}" target="_blank"> </a></td>
                                    <td th:text="${revision.action.name} + ' (' +${revision.action.code} + ')'"></td>
                                    <td th:text="${#dates.format(revision.startDate, 'dd MMM yyyy')}"></td>
                                    <td th:text="${#dates.format(revision.startTime, 'HH:mm')}"></td>
                                    <td th:text="${#dates.format(revision.endDate, 'dd MMM yyyy')}"></td>
                                    <td th:text="${#dates.format(revision.lastUpdateAt, 'dd MMM yyyy HH:mm a')}"></td>
                                    <td th:text="${revision.lastUpdateBy.fullName}"></td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<footer th:replace="fragments/footer :: footer"/>

<script th:inline="javascript">
    function removeAttachment(attachmentId, element){
        var attachmentIds = [];

        var arrayIds = $("#removedAttachmentsId").val();
        if (arrayIds == "") {
            attachmentIds.push(attachmentId);
        } else {
            attachmentIds.push(arrayIds,attachmentId);
        }

        $("#removedAttachmentsId").val(attachmentIds);
        element.parentNode.removeChild(element);
    }

    function generateTemplate() {
        if ($("#letterTemplateId").val() != "") {
            var _ctx = /*[[@{/}]]*/ 'context';
            window.location.replace(_ctx + "performance/generate_letter/" + $("#letterTemplateId").val());
        }
    }

    $(document).ready(function(){
        var _ctx = /*[[@{/}]]*/ 'context';
        var employeeId = [[${employee.id}]];

        var historyTable = $('#historyTable').on('preXhr.dt', function(e,settings,data){
            data.startDateFilter = $("#historyStartDatePicker").val();
            data.endDateFilter = $("#historyEndDatePicker").val();
            data.monthFilter = $("#historyMonthId").val();
        }).DataTable({
            "ajax":         _ctx + "performance/history/" + employeeId,
            "serverSide":   true,
            "processing": true,
            "pagingType":   "simple",
            "searching":    true,
            "lengthChange": false,
            "language": {
                "info":         "",
                "infoFiltered": "",
                "infoEmpty":    "",
                "infoPostFix":  "",
                "processing": "<div class='loader'></div>"
            },
            "columnDefs": [{
                "targets": [0,1,2,3,4,5,6],
                "orderable": false
            }],
            "columns": [
                { "data": "id", render: function(data, type, row)
                    {
                        return '<a href="' + _ctx + 'performance/'+ row.id +'">' + row.id + '</a>';
                    }
                },
                { "data": "action.id", render: function(data, type, row)
                    {
                        return row.action.name + ' (' + row.action.code + ')';
                    }
                },
                { "data": "startDate" },
                { "data": "startTime" },
                { "data": "endDate" },
                { "data": "lastUpdateAt" },
                { "data": "lastUpdateBy.fullName" }
            ],
            "rowCallback": function( row, data, index ) {
                    $(row).addClass('info');
            }
        });

        $('#parentCategoryId').change( function() {
            $.getJSON('' + _ctx + 'performance/categories', {
                parentCategoryId : $(this).val(),
                ajax : 'true'
            }, function(data) {
                var html = '<option value="">-- Please Select --</option>';
                var len = data.length;
                for ( var i = 0; i < len; i++) {
                    html += '<option value="' + data[i].id + '">'
                            + data[i].name + '</option>';
                }
                html += '</option>';

                $('#categoryId').html(html);
            });

            $.getJSON(_ctx + 'performance/actions', {
                parentCategoryId : $(this).val(),
                ajax : 'true'
            }, function(data) {
                var html = '<option value="">-- Please Select --</option>';
                var len = data.length;
                for ( var i = 0; i < len; i++) {
                    html += '<option value="' + data[i].id + '">'
                            + data[i].name + '</option>';
                }
                html += '</option>';

                $('#actionId').html(html);
            });

            $('#letterTemplateIdId').html('<option value="">-- Please Select --</option>');
        });

        $('#actionId').change( function() {
            $.getJSON(_ctx + 'performance/letter_templates', {
                actionId : $(this).val(),
                ajax : 'true'
            }, function(data) {
                var html = '<option value="">-- Please Select --</option>';
                var len = data.length;
                for ( var i = 0; i < len; i++) {
                    html += '<option value="' + data[i].id + '">'
                            + data[i].name + '</option>';
                }
                html += '</option>';

                $('#letterTemplateId').html(html);
            });
        });

        $("#historyActionId").change(function() {
            if ($("#historyActionId").val() != "") {
                historyTable.columns(1).search($("#historyActionId").val()).draw();
            } else {
                historyTable.columns(1).search("").draw();
            }
        });

        $('#datetimepicker1').datetimepicker({
            format: 'DD MMM YYYY'
        });

        $('#datetimepicker2').datetimepicker({
            format: 'DD MMM YYYY'
        });

        $('#datetimepicker3').datetimepicker({
            format: 'LT'
        });

        $('#historyStartDatePicker').datetimepicker({
            format: 'DD MMM YYYY'
        }).on("dp.change", function (e) {
            $('#historyMonthId').val("");
            historyTable.draw();
        });

        $('#historyEndDatePicker').datetimepicker({
            format: 'DD MMM YYYY'
        }).on("dp.change", function (e) {
            $('#historyMonthId').val("");
            historyTable.draw();
        });

        $("#historyTable_paginate, #historyTable_filter").hide();

        $("#historyMonthId").change(function() {
            $('#historyStartDatePicker, #historyEndDatePicker').val("");
            historyTable.draw();
        });
    });

    $(function () {
        // We can attach the `fileselect` event to all file inputs on the page
        $(document).on('change', ':file', function () {
            var input = $(this),
                    numFiles = input.get(0).files ? input.get(0).files.length : 1,
                    label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            input.trigger('fileselect', [numFiles, label]);
        });

        // We can watch for our custom `fileselect` event like this
        $(document).ready(function () {
            $(':file').on('fileselect', function (event, numFiles, label) {
                var input = $(this).parents('.input-group').find(':text'),
                        log = numFiles > 1 ? numFiles + ' files selected' : label;

                if (input.length) {
                    input.val(log);
                } else {
                    if (log) alert(log);
                }
            });
        });

    });
</script>
</body>
</html>